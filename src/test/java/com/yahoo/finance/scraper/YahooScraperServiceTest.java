package com.yahoo.finance.scraper;

import com.yahoo.finance.scraper.model.Ticker;
import com.yahoo.finance.scraper.service.YahooScraperService;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.context.testng.AbstractTestNGSpringContextTests;

import java.math.BigDecimal;
import java.math.RoundingMode;

import static org.junit.Assert.assertEquals;

@RunWith(SpringRunner.class)
@SpringBootTest
public class YahooScraperServiceTest extends AbstractTestNGSpringContextTests {
    @Autowired
    private YahooScraperService yahooScraperService;

    @Test
    public void testExtractTickerData() {
        String summaryHtml = "<div id=\"quote-summary\" class=\"Bxz(bb) D(ib) Va(t) Mih(250px)!--lgv2 W(100%) Mt(-6px) Mt(0px)--mobp Mt(0px)--mobl W(50%)!--lgv2 Mend(20px)!--lgv2 Pend(10px)!--lgv2 \" data-test=\"quote-summary-stats\"><div class=\"D(ib) W(1/2) Bxz(bb) Pend(12px) Va(t) ie-7_D(i) smartphone_D(b) smartphone_W(100%) smartphone_Pend(0px) smartphone_BdY smartphone_Bdc($seperatorColor)\" data-test=\"left-summary-table\"><table class=\"W(100%)\"><tbody><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>Previous Close</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"PREV_CLOSE-value\">238.26</td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>Open</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"OPEN-value\">237.61</td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>Bid</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"BID-value\">235.72 x 1400</td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>Ask</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"ASK-value\">235.98 x 1000</td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>Day's Range</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"DAYS_RANGE-value\">235.12 - 238.26</td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>52 Week Range</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"FIFTY_TWO_WK_RANGE-value\">120.99 - 243.10</td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>Volume</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"TD_VOLUME-value\"><fin-streamer data-symbol=\"BA\" data-field=\"regularMarketVolume\" data-trend=\"none\" data-pricehint=\"2\" data-dfield=\"longFmt\" value=\"2,636,080\" active=\"\">2,636,080</fin-streamer></td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) Bdbw(0)! \"><td class=\"C($primaryColor) W(51%)\"><span>Avg. Volume</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"AVERAGE_VOLUME_3MONTH-value\">5,548,300</td></tr></tbody></table></div><div class=\"D(ib) W(1/2) Bxz(bb) Pstart(12px) Va(t) ie-7_D(i) ie-7_Pos(a) smartphone_D(b) smartphone_W(100%) smartphone_Pstart(0px) smartphone_BdB smartphone_Bdc($seperatorColor)\" data-test=\"right-summary-table\"><table class=\"W(100%) M(0) Bdcl(c)\"><tbody><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>Market Cap</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"MARKET_CAP-value\">141.808B</td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>Beta (5Y Monthly)</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"BETA_5Y-value\">1.42</td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>PE Ratio (TTM)</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"PE_RATIO-value\">N/A</td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>EPS (TTM)</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"EPS_RATIO-value\">-7.09</td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>Earnings Date</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"EARNINGS_DATE-value\"><span>Oct 24, 2023</span> - <span>Oct 30, 2023</span></td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>Forward Dividend &amp; Yield</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"DIVIDEND_AND_YIELD-value\">N/A (N/A)</td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) \"><td class=\"C($primaryColor) W(51%)\"><span>Ex-Dividend Date</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"EX_DIVIDEND_DATE-value\"><span>Feb 13, 2020</span></td></tr><tr class=\"Bxz(bb) Bdbw(1px) Bdbs(s) Bdc($seperatorColor) H(36px) Bdbw(0)! \"><td class=\"C($primaryColor) W(51%)\"><span>1y Target Est</span></td><td class=\"Ta(end) Fw(600) Lh(14px)\" data-test=\"ONE_YEAR_TARGET_PRICE-value\">251.20</td></tr></tbody></table></div></div>";
        String profileHtml = "<section class=\"Pb(30px) smartphone_Px(20px)\" data-yaft-module=\"tdv2-applet-CompanyProfile\"><div class=\"asset-profile-container\" data-test=\"asset-profile\"><h2 class=\"Fz(m) Lh(1) Fw(b) Mt(0)\"></h2><div class=\"Pt(10px) smartphone_Pt(20px) Lh(1.7)\" data-test=\"qsp-profile\"><h3 class=\"Fz(m) Mb(10px)\">The Boeing Company</h3><div class=\"Mb(25px)\"><p class=\"D(ib) W(47.727%) Pend(40px)\">929 Long Bridge Drive<br>Arlington, VA 22202<br>United States<br><a href=\"tel:7034653500\" class=\"C($linkColor)\">703 465 3500</a><br><a href=\"https://www.boeing.com\" rel=\"noopener noreferrer\" target=\"_blank\" class=\"C($linkColor)\" title=\"\">https://www.boeing.com</a></p><p class=\"D(ib) Va(t)\"><span>Sector(s)</span>:&nbsp;<span class=\"Fw(600)\">Industrials</span><br><span>Industry</span>:&nbsp;<span class=\"Fw(600)\">Aerospace &amp; Defense</span><br><span>Full Time Employees</span>:&nbsp;<span class=\"Fw(600)\"><span>156,000</span></span></p></div></div></div><section class=\"Bxz(bb) quote-subsection undefined\"><h3 class=\"Fz(m) Fw(br) Mb(15px) Mt(0)\"><span>Key Executives</span></h3><table class=\"W(100%)\"><thead><tr class=\"C($tertiaryColor) Fz(xs) BdB Bdc($seperatorColor)\"><th class=\"Ta(start) Py(6px) Fw(n)\"><span>Name</span></th><th class=\"Ta(start) Py(6px) Fw(n)\"><span>Title</span></th><th class=\"Ta(end) Py(6px) Fw(n)\"><span>Pay</span></th><th class=\"Ta(end) Py(6px) Fw(n)\"><span>Exercised</span></th><th class=\"Ta(end) Py(6px) Fw(n)\"><span>Year Born</span></th></tr></thead><tbody><tr class=\"C($primaryColor) BdB Bdc($seperatorColor) H(36px)\"><td class=\"Ta(start)\"><span class=\"\">Mr. David L. Calhoun</span></td><td class=\"Ta(start) W(45%)\"><span class=\"\">Pres, CEO &amp; Director</span></td><td class=\"Ta(end)\"><span class=\"\">5.48M</span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\">1958</span></td></tr><tr class=\"C($primaryColor) BdB Bdc($seperatorColor) H(36px)\"><td class=\"Ta(start)\"><span class=\"\">Mr. Brian J. West</span></td><td class=\"Ta(start) W(45%)\"><span class=\"\">Exec. VP of Fin. &amp; CFO</span></td><td class=\"Ta(end)\"><span class=\"\">2.64M</span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\">1970</span></td></tr><tr class=\"C($primaryColor) BdB Bdc($seperatorColor) H(36px)\"><td class=\"Ta(start)\"><span class=\"\">Mr. Brett C. Gerry</span></td><td class=\"Ta(start) W(45%)\"><span class=\"\">Chief Legal Officer &amp; Exec. VP of Global Compliance</span></td><td class=\"Ta(end)\"><span class=\"\">2.18M</span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\">1972</span></td></tr><tr class=\"C($primaryColor) BdB Bdc($seperatorColor) H(36px)\"><td class=\"Ta(start)\"><span class=\"\">Mr. Stanley A. Deal</span></td><td class=\"Ta(start) W(45%)\"><span class=\"\">Exec. VP and Pres &amp; CEO of Boeing Commercial Airplanes</span></td><td class=\"Ta(end)\"><span class=\"\">3.16M</span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\">1964</span></td></tr><tr class=\"C($primaryColor) BdB Bdc($seperatorColor) H(36px)\"><td class=\"Ta(start)\"><span class=\"\">Mr. Theodore  Colbert III</span></td><td class=\"Ta(start) W(45%)\"><span class=\"\">Exec. VP, Pres and CEO of Boeing Defense, Space &amp; Security</span></td><td class=\"Ta(end)\"><span class=\"\">2.2M</span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\">1974</span></td></tr><tr class=\"C($primaryColor) BdB Bdc($seperatorColor) H(36px)\"><td class=\"Ta(start)\"><span class=\"\">Mr. Andrew  Ward</span></td><td class=\"Ta(start) W(45%)\"><span class=\"\">Chief Investment Officer</span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\">1971</span></td></tr><tr class=\"C($primaryColor) BdB Bdc($seperatorColor) H(36px)\"><td class=\"Ta(start)\"><span class=\"\">Dr. Todd  Citron Ph.D.</span></td><td class=\"Ta(start) W(45%)\"><span class=\"\">Chief Technology Officer, VP and GM of Boeing Research &amp; Technology</span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td></tr><tr class=\"C($primaryColor) BdB Bdc($seperatorColor) H(36px)\"><td class=\"Ta(start)\"><span class=\"\">Ms. Susan  Doniz BSc, ICD.D</span></td><td class=\"Ta(start) W(45%)\"><span class=\"\">Chief Information &amp; Data Analytics Officer</span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\">1970</span></td></tr><tr class=\"C($primaryColor) BdB Bdc($seperatorColor) H(36px)\"><td class=\"Ta(start)\"><span class=\"\">Matt  Welch</span></td><td class=\"Ta(start) W(45%)\"><span class=\"\">VP of Investor Relations</span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td></tr><tr class=\"C($primaryColor) BdB Bdc($seperatorColor) H(36px)\"><td class=\"Ta(start)\"><span class=\"\">Mr. Darrin A. Hostetler</span></td><td class=\"Ta(start) W(45%)\"><span class=\"\">Chief Compliance Officer &amp; VP of Global Compliance</span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td><td class=\"Ta(end)\"><span class=\"\"><span>N/A</span></span></td></tr></tbody></table></section><div class=\"Fz(xs) Lh(1.6) C($tertiaryColor) Mt(10px)\"><span>Amounts are as of <span>December 31, 2022</span> and compensation values are for the last fiscal year ending on that date. Pay is salary, bonuses, etc. Exercised is the value of options exercised during the fiscal year. Currency in USD.</span></div><div data-test=\"yahoo-map\" class=\"Mt(30px) Mb(35px)\" style=\"width: 100%; height: 410px; background: url(&quot;https://gws2.maps.yahoo.com/mapimage?appid=y-finance&amp;imw=880&amp;imh=410&amp;imi=1-h-gws-2x&amp;radius=700&amp;zoom=10&amp;q=929%20Long%20Bridge%20Drive%2CArlington%2CVA%2CUnited%20States&quot;) no-repeat;\"></div><section class=\"quote-sub-section Mt(30px)\"><h2 class=\"Fz(m) Lh(1) Fw(b) Mt(0) Mb(18px)\"><span>Description</span></h2><p class=\"Mt(15px) Lh(1.6)\">The Boeing Company, together with its subsidiaries, designs, develops, manufactures, sells, services, and supports commercial jetliners, military aircraft, satellites, missile defense, human space flight and launch systems, and services worldwide. The company operates through four segments: Commercial Airplanes; Defense, Space &amp; Security; Global Services; and Boeing Capital. The Commercial Airplanes segment develops, produces, and markets commercial jet aircraft for passenger and cargo requirements, as well as provides fleet support services. The Defense, Space &amp; Security segment engages in the research, development, production, and modification of manned and unmanned military aircraft and weapons systems; strategic defense and intelligence systems, which include strategic missile and defense systems, command, control, communications, computers, intelligence, surveillance and reconnaissance, cyber and information solutions, and intelligence systems; and satellite systems, such as government and commercial satellites, and space exploration. The Global Services segment offers products and services, including supply chain and logistics management, engineering, maintenance and modifications, upgrades and conversions, spare parts, pilot and maintenance training systems and services, technical and maintenance documents, and data analytics and digital services to commercial and defense customers. The Boeing Capital segment offers financing services and manages financing exposure for a portfolio of equipment under operating leases, sales-type/finance leases, notes and other receivables, assets held for sale or re-lease, and investments. The company was incorporated in 1916 and is based in Arlington, Virginia.</p></section><section class=\"Mt(30px) corporate-governance-container\"><h2 class=\"Fz(m) Lh(1) Fw(b) Mt(0) Mb(18px)\"><span>Corporate Governance</span></h2><div><p class=\"Fz(s)\"><span>The Boeing Companyâ€™s ISS Governance QualityScore as of <span>August 1, 2023</span> is 8.</span>  <span>The pillar scores are Audit: 5; Board: 1; Shareholder Rights: 5; Compensation: 10.</span></p><div class=\"Mt(20px)\"><span>Corporate governance scores courtesy of</span> <a href=\"https://issgovernance.com/quickscore\" target=\"_blank\" rel=\"noopener noreferrer\" title=\"Institutional Shareholder Services (ISS)\">Institutional Shareholder Services (ISS)</a>.  <span>Scores indicate decile rank relative to index or region. A decile score of 1 indicates lower governance risk, while a 10 indicates higher governance risk.</span></div></div></section></section>";
        Document profileDocument = Jsoup.parse(profileHtml);
        Document summaryDocument = Jsoup.parse(summaryHtml);

        Ticker ticker = yahooScraperService.getTickerData("BA", profileDocument, summaryDocument);

        assertEquals("The Boeing Company", ticker.getCompanyName());
        assertEquals("BA", ticker.getTickerSymbol());
        assertEquals("141.808B", ticker.getMarketCap());
        assertEquals(new BigDecimal(237.61).setScale(2, RoundingMode.HALF_UP), ticker.getStockPrices().get(0).getOpenPrice());
        assertEquals(new BigDecimal(238.26).setScale(2, RoundingMode.HALF_UP), ticker.getStockPrices().get(0).getPreviousClosePrice());
        assertEquals(156000, ticker.getNumberOfEmployees());
        assertEquals("Arlington", ticker.getCity());
        assertEquals("VA", ticker.getState());
        assertEquals(1916, ticker.getYearFounded());
    }

}